import chai from 'chai';
chai.should();
import chaiAsPromised from 'chai-as-promised';
chai.use(chaiAsPromised);
import request from 'supertest';
import sinon from 'sinon';
import sinonChai from 'sinon-chai';
import mongoose from 'mongoose';
chai.use(sinonChai);
import _ from 'lodash';

import response from '../../src/services/response/index.js';
import routerPromise from '../../src/routes/index.js';
import modelsPromise from '../../src/models/index.js';
import { waitForQueueDrained } from '../helpers.js';
import { getQueue } from '../../src/services/queue/bull.js';

// Hit the running API server (e.g. npm start on port 8080). Set TEST_API_BASEURL to override.
const baseURL = process.env.TEST_API_BASEURL || 'http://localhost:8080';
const agent = request(baseURL);

// No before/after: tests target the running server at TEST_API_BASEURL (default http://localhost:8080).

const header: Record<string, unknown> = {};
const res: Record<string, unknown> = {};
const req: Record<string, unknown> = {};
let nextChecker = false;
const _next = function(): boolean{
    if(arguments.length > 0){
        console.log(arguments[0]);
    }else{
        nextChecker = true;
    }
    return nextChecker;
};
res.json = function(_data: unknown){ return res; };
res.badRequest = sinon.spy();
res.status = function(_status: unknown){ return res; };
res.set = function(key: string, value: unknown){ header[key] = value; return value; };
req.get = function(key: string){ return header[key]; };
header.set = function(data: unknown){ header.temp = data; return data; };
req.method = '';

let tag;
const _objId1 = new (mongoose.Types as any).ObjectId('59abab38ead925031a71496d');
const _objId2 = new (mongoose.Types as any).ObjectId('59abab38ead925031a71496e');
const _objId3 = new (mongoose.Types as any).ObjectId('59abab38ead925031a71496c');
let last;
let oneId;
let oneId2;
const from = new Date(new Date().setMinutes(new Date().getMinutes() - 3)).toISOString();
// Requires the API server to be running (e.g. npm start → http://localhost:8080).
// Override with TEST_API_BASEURL if your server uses a different URL.
describe('/<%= namePlural %> (API → local /<%= endpoint %>)', function(){
    this.timeout(60000);

    before(function(done){
        agent
            .get('/initialize')
            .then(function(resp){
                tag = resp.body.data['x-tag'];
                done();
            })
            .catch(function(err){
                done(err);
            });
    });

    it('should create a document', function(done){
        agent
        .post('/<%= namePlural %>')
        .set('x-tag',tag)
        .send({name: 'femi2'})
        .then(function(resp){
            oneId = resp.body.data != null ? resp.body.data._id : undefined;
            done();
        })
        .catch(function(err){
            done(err);
        });
    });

    it('should create documents', function(done){
        agent
        .post('/<%= namePlural %>')
        .set('x-tag',tag)
        .send([{name: 'femi',toPop: oneId},{name: 'tolu',toPop: oneId},{name: 'femi2',toPop: oneId},{name: 'bola',toPop: oneId}])
        .then(function(resp){
            oneId2 = resp.body.data[0]._id;
            resp.body.data.length.should.be.above(0);
            done();
        })
        .catch(function(err){
            done(err);
        });
    });
    

    describe('Find', function(){
        it('should search for matching documents for a given string', function(done){
            agent
            .get('/<%= namePlural %>?search=femi')
            .set('x-tag',tag)
            .expect(200, done);
        });
        it('should limit the number of returned documents',function(done){
            agent
            .get('/<%= namePlural %>?limit=2')
            .set('x-tag',tag)
            .then(function(resp){
                resp.body.data.length.should.equal(2);
                done();
            })
            .catch(function(err){
                done(err);
            });
        });
        it('should contain count of total record for the query', function(done){
            agent
            .get('/<%= namePlural %>')
            .set('x-tag',tag)
            .then(function(resp){
                resp.body.total.should.exist; /* jslint ignore:line */
                done();
            })
            .catch(function(err){
                done(err);
            });
        });
        it('should return the last document Id in the array of documents returned from a query', function(done){
            agent
            .get('/<%= namePlural %>?limit=2')
            .set('x-tag',tag)
            .then(function(resp){
                last = resp.body.lastId;
                resp.body.lastId.should.exist; /* jslint ignore:line */
                done();
            })
            .catch(function(err){
                done(err);
            });
        });
        it('should sort documents in ascending order', function(done){
            agent
            .get('/<%= namePlural %>?sort=name')
            .set('x-tag',tag)
            .expect(200,done);
        });
        it('should sort documents in descending order', function(done){
            agent
            .get('/<%= namePlural %>?sort=-name')
            .set('x-tag',tag)
            .expect(200,done);
        });
        it('should select just few parameters from the documents', function(done){
            agent
            .get('/<%= namePlural %>?select=name')
            .set('x-tag',tag)
            .expect(200,done);
        });
        it('should populate data of a reference for multiple data', function(done){
            agent
            .get('/<%= namePlural %>?populate=toPop')
            .set('x-tag',tag)
            .then(function(resp){
                _.forEach(resp.body.data, function(value){
                    if(value._id === oneId2){
                        value.toPop.should.be.an('object');
                    }
                });
                done();
            })
            .catch(function(err){
                done(err);
            });
        });

        it('should populate data of a reference for single data', function(done){
            agent
            .get('/<%= namePlural %>/'+oneId2+'?populate=toPop')
            .set('x-tag',tag)
            .then(function(resp){
                resp.body.data.should.have.property('toPop');
                // Backend may return populated object (Mongo) or ref ID as string/number (SQL/API)
                const toPop = resp.body.data.toPop;
                ((typeof toPop === 'object' && toPop !== null) || typeof toPop === 'string' || typeof toPop === 'number').should.equal(true);
                done();
            })
            .catch(function(err){
                done(err);
            });
        });

        it('should load next page for pagination', function(done){
            agent
            .get('/<%= namePlural %>?lastId='+last+'')
            .set('x-tag',tag)
            .expect(200,done);
        });
        it('should filter by date range', function(done){
            agent
            .get('/<%= namePlural %>?from='+from+'&to='+new Date().toISOString())
            .set('x-tag',tag)
            .then(function(resp){
                resp.body.data.length.should.be.above(0);
                done();
            })
            .catch(function(err){
                done(err);
            });
        });
        it('should filter by date range without setting the end date', function(done){
            agent
            .get('/<%= namePlural %>?from='+from)
            .set('x-tag',tag)
            .then(function(resp){
                resp.body.data.length.should.be.above(0);
                done();
            })
            .catch(function(err){
                done(err);
            });
        });
    });

it('should find one document', function(done){
    agent
    .get('/<%= namePlural %>/'+oneId+'')
    .set('x-tag',tag)
    .then(function(resp){
        resp.body.data.should.be.an('object');
        done();
    })
    .catch(function(err){
        done(err);
    });
});
it('should update documents', function(done){
    agent
    .put('/<%= namePlural %>?name=femi')
    .set('x-tag',tag)
    .send({name: 'Bukola'})
    .then(function(resp){
        // Backend may return object (Mongo) or array (SQL)
        resp.body.should.have.property('data');
        done();
    })
    .catch(function(err){
        done(err);
    });
});
it('should update a document', function(done){
    agent
    .patch('/<%= namePlural %>/'+oneId+'')
    .set('x-tag',tag)
    .send({name: 'Bukola'})
    .then(function(resp){
        resp.body.data.should.be.an('object');
        done();
    })
    .catch(function(err){
        done(err);
    });
});

describe('Delete', function(){

    it('should delete multiple data', function(done){
        agent
        .delete('/<%= namePlural %>?name=femi2')
        .set('x-tag',tag)
        .then(function(resp){
            resp.body.data.should.be.an('array');
            done();
        })
        .catch(function(err){
            done(err);
        });
    });

    it('should delete one data', function(done){
        agent
        .delete('/<%= namePlural %>/'+oneId+'')
        .set('x-tag',tag)
        .then(function(resp){
            resp.body.data.should.be.an('object');
            done();
        })
        .catch(function(err){
            done(err);
        });
    });
});

describe('Restore', function(){
    it('should restore a previously deleted data', function(done){
        if (oneId == null) {
            done(new Error('oneId not set - create/delete tests may have failed'));
            return;
        }
        // Query with oneId as-is so we match Trash.data._id (number for SQL, string for Mongo)
        waitForQueueDrained(getQueue, 'saveToTrash', 15000)
            .then(function() {
                return import('../../src/models/index.js').then((m) => m.default);
            })
            .then(function(models) {
                const Trash = models.Trash;
                return (Trash as { findOne: (q: object) => Promise<{ _id: string } | null> }).findOne({'data._id': oneId});
            })
            .then(function(trashDoc){
                if (!trashDoc || !trashDoc._id) {
                    return Promise.reject(new Error('Trash document not found for deleted id'));
                }
                return agent
                    .post('/<%= namePlural %>/' + trashDoc._id + '/restore')
                    .set('x-tag', tag);
            })
            .then(function(apiResp: { body?: { data?: unknown } }){
                if (apiResp && apiResp.body && apiResp.body.data != null) {
                    (apiResp.body as { data: unknown }).data.should.be.an('object');
                }
                done();
            })
            .catch(function(err){
                done(err);
            });
    });
});
});
